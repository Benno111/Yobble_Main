<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - Yobble</title>
<link rel="stylesheet" href="/style.css">
<style>
  :root{
    --pro-bg:#0a0d12;
    --pro-ink:#eef2ff;
    --pro-muted:#a5b0c6;
    --pro-card:#141a24;
    --pro-border:#283043;
    --pro-accent:#c7b6ff;
    --pro-accent-2:#4dd4ff;
  }
  body{
    background:radial-gradient(circle at 14% 15%,rgba(199,182,255,.16),transparent 40%),
               radial-gradient(circle at 85% 10%,rgba(77,212,255,.14),transparent 45%),
               var(--pro-bg);
    color:var(--pro-ink);
    font-family:"Space Grotesk","IBM Plex Sans","Segoe UI",sans-serif;
  }
  main{max-width:1200px}
  .pro-wrap{display:flex;flex-direction:column;gap:18px}
  .hero{
    display:grid;
    grid-template-columns:1.1fr .9fr;
    gap:20px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }
  .hero::before{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(120deg,rgba(199,182,255,.2),transparent 40%),
               linear-gradient(240deg,rgba(77,212,255,.12),transparent 40%);
    pointer-events:none;
  }
  .hero h1{margin:0 0 8px;font-size:38px}
  .hero p{margin:0;color:var(--pro-muted)}
  .hero-meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .pill{
    border:1px solid var(--pro-border);
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    color:var(--pro-muted);
    background:rgba(20,26,36,.6);
  }
  .pill.action{
    border-color:rgba(255,209,102,.45);
    color:var(--pro-ink);
    background:rgba(255,209,102,.18);
  }
  .hero-art{
    border-radius:16px;
    border:1px solid var(--pro-border);
    min-height:160px;
    background:
      linear-gradient(130deg,rgba(199,182,255,.25),rgba(20,26,36,.45)),
      repeating-linear-gradient(45deg,rgba(255,255,255,.05) 0 10px,transparent 10px 20px);
    display:flex;
    align-items:flex-end;
    padding:16px;
    font-weight:600;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:16px;
  }
  .profile-card{
    background:var(--pro-card);
    border:1px solid var(--pro-border);
    border-radius:16px;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .profile-name{font-size:20px;font-weight:700}
  .profile-meta{color:var(--pro-muted);font-size:12px}
  .profile-status{color:var(--pro-accent-2);font-size:13px}
  .bio-editor{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .bio-input{
    min-height:96px;
    border-radius:12px;
    border:1px solid var(--pro-border);
    background:#0f141d;
    color:var(--pro-ink);
    padding:10px 12px;
    resize:vertical;
    font-family:"Space Grotesk","IBM Plex Sans","Segoe UI",sans-serif;
    font-size:13px;
  }
  .bio-actions{
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }
  .bio-save{
    border:1px solid rgba(77,212,255,.45);
    background:rgba(77,212,255,.2);
    color:var(--pro-ink);
    padding:6px 12px;
    border-radius:999px;
    font-size:12px;
    cursor:pointer;
  }
  .bio-msg{
    color:var(--pro-muted);
    font-size:12px;
  }
  .empty{
    text-align:center;
    padding:30px;
    color:var(--pro-muted);
  }
  @media (max-width: 900px){
    .hero{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main class="pro-wrap">
  <section class="card hero">
    <div>
      <div class="pill">Profile</div>
      <h1>Your account</h1>
      <p>Manage your identity, status, and public profile details.</p>
      <div class="hero-meta">
        <span class="pill" id="stat-role">Role</span>
        <span class="pill" id="stat-updated">Updated</span>
      </div>
    </div>
    <div class="hero-art">Player identity</div>
  </section>

  <section class="grid" id="cards"></section>
  <section class="card empty" id="empty" hidden>Profile unavailable.</section>
</main>

<script type="module">
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api.js";
import { logout } from "/js/auth.js";

await mountTopbar("profile");

const cards = document.getElementById("cards");
const empty = document.getElementById("empty");
const statRole = document.getElementById("stat-role");
const statUpdated = document.getElementById("stat-updated");
const params = new URLSearchParams(location.search);
const lookupUser = params.get("u");

function escapeHtml(v){
  return String(v ?? "").replace(/[&<>"']/g, (c) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[c]));
}

let profile = null;
try{
  if (lookupUser) {
    const res = await api.get(`/api/profile/lookup-exact?u=${encodeURIComponent(lookupUser)}`);
    profile = res.profile || null;
  } else {
    const res = await api.get("/api/profile/me");
    profile = res.profile || res;
  }
}catch(err){
  if (lookupUser) {
    if (err?.status === 403 && err?.data?.error === "account_banned") {
      location.href = "/404.html?msg=" + encodeURIComponent("Account deleted.");
      throw err;
    }
    if (err?.status === 403 && err?.data?.error === "account_timed_out") {
      const until = err?.data?.until ? new Date(Number(err.data.until)).toLocaleString() : "unknown";
      location.href = "/404.html?msg=" + encodeURIComponent(`User is temporarily banned until ${until}.`);
      throw err;
    }
    if (err?.status === 404) {
      location.href = "/404.html?msg=" + encodeURIComponent("User not found.");
      throw err;
    }
  }
  empty.hidden = false;
  empty.textContent = "Could not load profile.";
}

if(profile){
  const isSelf = !lookupUser;
  statRole.textContent = profile.role ? `Role ${profile.role}` : "Role";
  const updated = profile.updated_at ? new Date(profile.updated_at).toLocaleDateString() : "—";
  statUpdated.textContent = `Updated ${updated}`;

  cards.innerHTML = `
    <div class="profile-card">
      <div class="profile-name">${escapeHtml(profile.display_name || profile.username || "Player")}</div>
      <div class="profile-meta">@${escapeHtml(profile.username || "unknown")}</div>
      <div class="profile-status">${escapeHtml(profile.status_text || "No status set yet.")}</div>
      ${isSelf ? "" : `<a class="pill" href="/report.html?target_type=user&target_id=${encodeURIComponent(profile.id)}">Report</a>`}
    </div>
    <div class="profile-card">
      <div class="profile-meta">Account</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div class="profile-name">${escapeHtml(profile.role || "user")}</div>
        ${
          isSelf
            ? `<button class="pill action" id="logoutBtn" type="button">Logout</button>`
            : `<a class="pill action" href="/report.html?target_type=user&target_ref=${encodeURIComponent(profile.username || "")}">Report</a>`
        }
      </div>
      <div class="profile-meta">User ID ${escapeHtml(profile.id ?? "—")}</div>
    </div>
    <div class="profile-card">
      <div class="profile-meta">Bio</div>
      ${
        isSelf
          ? `
        <div class="bio-editor">
          <textarea class="bio-input" id="bioInput" placeholder="Add a bio to tell others who you are.">${escapeHtml(profile.bio || "")}</textarea>
          <div class="bio-actions">
            <span class="bio-msg" id="bioMsg"></span>
            <button class="bio-save" id="bioSave" type="button">Save</button>
          </div>
        </div>
      `
          : `<div>${escapeHtml(profile.bio || "Add a bio to tell others who you are.")}</div>`
      }
    </div>
  `;

  if(isSelf){
    const logoutBtn = document.getElementById("logoutBtn");
    if(logoutBtn){
      logoutBtn.addEventListener("click", logout);
    }
    const bioInput = document.getElementById("bioInput");
    const bioSave = document.getElementById("bioSave");
    const bioMsg = document.getElementById("bioMsg");
    if(bioSave && bioInput && bioMsg){
      bioSave.addEventListener("click", async () => {
        bioMsg.textContent = "";
        try{
          await api("/api/profile/me", { method:"PATCH", body:{ bio: bioInput.value }});
          bioMsg.textContent = "Saved.";
        }catch(e){
          bioMsg.textContent = "Save failed.";
        }
      });
    }
  }
}else{
  if (lookupUser) {
    location.href = "/404.html?msg=" + encodeURIComponent("User not found.");
  } else {
    empty.hidden = false;
  }
}
</script>
</body>
</html>
