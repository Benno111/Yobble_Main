<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Dashboard - Yobble</title>
<link rel="stylesheet" href="/style.css">
<style>
  :root{
    --dash-bg:#0a0d12;
    --dash-ink:#eef2ff;
    --dash-muted:#9aa6c1;
    --dash-card:#141a24;
    --dash-border:#283043;
    --dash-accent:#4dd4ff;
  }
  body{
    background:radial-gradient(circle at 20% 15%,rgba(77,212,255,.16),transparent 45%),
               radial-gradient(circle at 85% 10%,rgba(255,209,102,.12),transparent 45%),
               var(--dash-bg);
    color:var(--dash-ink);
    font-family:"Space Grotesk","IBM Plex Sans","Segoe UI",sans-serif;
  }
  main{max-width:1200px}
  .dash-wrap{display:flex;flex-direction:column;gap:18px}
  .hero{
    display:grid;
    grid-template-columns:1.2fr .8fr;
    gap:20px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }
  .hero::before{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(120deg,rgba(77,212,255,.16),transparent 45%),
               linear-gradient(240deg,rgba(255,209,102,.12),transparent 40%);
    pointer-events:none;
  }
  .hero h1{margin:8px 0;font-size:34px}
  .hero p{margin:0;color:var(--dash-muted)}
  .pill{
    border:1px solid var(--dash-border);
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    color:var(--dash-muted);
    background:rgba(20,26,36,.6);
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:16px;
  }
  .card{
    background:var(--dash-card);
    border:1px solid var(--dash-border);
    border-radius:16px;
    padding:16px;
  }
  .section-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .section-title h2{margin:0;font-size:18px}
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th, td{
    text-align:left;
    padding:8px 6px;
    border-bottom:1px solid var(--dash-border);
  }
  th{color:var(--dash-muted);font-weight:600}
  .empty{
    text-align:center;
    color:var(--dash-muted);
    padding:20px;
  }
  .badge{
    border-radius:999px;
    padding:3px 8px;
    font-size:11px;
    border:1px solid rgba(255,255,255,.1);
    background:rgba(20,26,36,.7);
    color:var(--dash-ink);
  }
  .badge.accent{background:rgba(77,212,255,.16);border-color:rgba(77,212,255,.4)}
  .progress{
    width:100%;
    height:8px;
    border-radius:999px;
    background:#0f151f;
    border:1px solid var(--dash-border);
    overflow:hidden;
    margin-top:8px;
  }
  .progress > span{
    display:block;
    height:100%;
    width:0%;
    background:linear-gradient(120deg,var(--dash-accent),#ffd166);
    transition:width .2s ease;
  }
  @media (max-width: 900px){
    .hero{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main class="dash-wrap">
  <section class="card hero">
    <div>
      <span class="pill">Game dashboard</span>
      <h1 id="gameTitle">Loading…</h1>
      <p id="gameDesc" class="muted">Fetching game data.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <span class="pill" id="gameSlug">Slug —</span>
        <span class="pill" id="gameCategory">Category —</span>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="section-title">
          <h2>Overview</h2>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <span class="badge accent" id="latestVersion">Latest —</span>
          <span class="badge" id="publishedVersion">Published —</span>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="section-title">
      <h2>Dashboard</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="badge accent" data-tab="versions">Versions</button>
        <button class="badge" data-tab="uploads">Uploads</button>
        <button class="badge" data-tab="analytics">Analytics</button>
      </div>
    </div>
    <div id="tab-versions" style="margin-top:12px"></div>
    <div id="tab-uploads" style="margin-top:12px" hidden></div>
    <div id="tab-analytics" style="margin-top:12px" hidden></div>
  </section>
</main>

<script type="module">
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api.js";

await mountTopbar("games");

const params = new URLSearchParams(location.search);
const slug = params.get("slug") || "";

const gameTitle = document.getElementById("gameTitle");
const gameDesc = document.getElementById("gameDesc");
const gameSlug = document.getElementById("gameSlug");
const gameCategory = document.getElementById("gameCategory");
const latestVersion = document.getElementById("latestVersion");
const publishedVersion = document.getElementById("publishedVersion");
const versionsEl = document.getElementById("tab-versions");
const uploadsEl = document.getElementById("tab-uploads");
const analyticsEl = document.getElementById("tab-analytics");
const uploadFormId = "versionUploadForm";

function escapeHtml(v){
  return String(v ?? "").replace(/[&<>"']/g, (c) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[c]));
}

function formatDate(ms){
  if (!ms) return "—";
  return new Date(ms).toLocaleString();
}

if(!slug){
  gameTitle.textContent = "Missing slug";
  gameDesc.textContent = "Provide ?slug= in the URL.";
}else{
  try{
    const res = await api.get("/api/gamehosting/versions?slug=" + encodeURIComponent(slug));
    const g = res.game || {};
    const versions = res.versions || [];
    const uploads = res.uploads || [];

    gameTitle.textContent = g.title || "Untitled";
    gameDesc.textContent = g.description || "No description yet.";
    gameSlug.textContent = `Slug ${g.slug || slug}`;
    gameCategory.textContent = `Category ${g.category || "Uncategorized"}`;

    const latest = versions[0]?.version || "—";
    const published = versions.find(v => v.is_published)?.version || "—";
    latestVersion.textContent = `Latest ${latest}`;
    publishedVersion.textContent = `Published ${published}`;

    if(versions.length){
      versionsEl.innerHTML = `
        <form id="${uploadFormId}" style="margin-bottom:16px">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
            <div>
              <label class="muted">Version</label>
              <input name="version" required placeholder="e.g. 1.0.1" style="width:100%;margin-top:6px">
            </div>
            <div>
              <label class="muted">Entry HTML</label>
              <input name="entry_html" placeholder="index.html" style="width:100%;margin-top:6px">
            </div>
            <div>
              <label class="muted">Zip file</label>
              <input type="file" name="zip" accept=".zip" required style="width:100%;margin-top:6px">
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <button class="badge accent" type="submit">Upload update</button>
            <span class="muted" id="uploadMsg"></span>
          </div>
          <div class="progress" aria-hidden="true">
            <span id="uploadProgress"></span>
          </div>
        </form>
        <table>
          <thead>
            <tr>
              <th>Version</th>
              <th>Status</th>
              <th>Published</th>
              <th>Uploaded</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${versions.map(v => `
              <tr>
                <td>${escapeHtml(v.version)}</td>
                <td>${escapeHtml(v.approval_status || "pending")}</td>
                <td>${v.is_published ? "Yes" : "No"}</td>
                <td>${escapeHtml(formatDate(v.created_at))}</td>
                <td>
                  ${v.is_published
                    ? `<button class="badge accent" data-unpublish="${escapeHtml(v.version)}">Unpublish</button>`
                    : v.approval_status === "approved"
                      ? `<button class="badge accent" data-publish="${escapeHtml(v.version)}">Publish</button>`
                      : `<span class="muted">—</span>`}
                  ${v.approval_status === "rejected"
                    ? `<button class="badge accent" data-resubmit="${escapeHtml(v.version)}">Resubmit</button>`
                    : ""}
                  <button class="badge" data-whitelist="${escapeHtml(v.version)}">Whitelist</button>
                  <button class="badge" data-delete="${escapeHtml(v.version)}">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      versionsEl.querySelectorAll("[data-publish]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const v = btn.getAttribute("data-publish");
          try{
            await api.post("/api/gamehosting/publish-owner", { slug, version: v, published: true });
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      versionsEl.querySelectorAll("[data-unpublish]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try{
            await api.post("/api/gamehosting/publish-owner", { slug, published: false });
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      versionsEl.querySelectorAll("[data-whitelist]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const v = btn.getAttribute("data-whitelist");
          try{
            const res = await api.get(`/api/gamehosting/whitelist?slug=${encodeURIComponent(slug)}&version=${encodeURIComponent(v)}`);
            const current = (res.usernames || []).join(", ");
            const input = prompt("Whitelist usernames (comma separated):", current);
            if (input === null) return;
            const usernames = input.split(",").map(u => u.trim()).filter(Boolean);
            await api.post("/api/gamehosting/whitelist", { slug, version: v, usernames });
            btn.textContent = "Saved";
            setTimeout(() => { btn.textContent = "Whitelist"; }, 1000);
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      versionsEl.querySelectorAll("[data-delete]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const v = btn.getAttribute("data-delete");
          if (!confirm(`Delete version ${v}? This cannot be undone.`)) return;
          try{
            await api.post("/api/gamehosting/version/delete", { slug, version: v });
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      versionsEl.querySelectorAll("[data-resubmit]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const v = btn.getAttribute("data-resubmit");
          try{
            await api.post("/api/gamehosting/version/resubmit", { slug, version: v });
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });

      const uploadForm = document.getElementById(uploadFormId);
      if(uploadForm){
        uploadForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("uploadMsg");
          const bar = document.getElementById("uploadProgress");
          msg.textContent = "";
          bar.style.width = "0%";
          const fd = new FormData(uploadForm);
          fd.set("slug", slug);
          fd.set("title", g.title || slug);
          fd.set("entry_html", fd.get("entry_html") || "index.html");
          try{
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/gamehosting/upload");
            xhr.upload.addEventListener("progress", (evt) => {
              if (!evt.lengthComputable) return;
              const pct = Math.round((evt.loaded / evt.total) * 100);
              bar.style.width = pct + "%";
            });
            xhr.addEventListener("load", () => {
              if (xhr.status >= 200 && xhr.status < 300) {
                msg.textContent = "Uploaded.";
                location.reload();
              } else {
                msg.textContent = "Upload failed.";
              }
            });
            xhr.addEventListener("error", () => {
              msg.textContent = "Upload failed.";
            });
            xhr.send(fd);
          }catch{
            msg.textContent = "Upload failed.";
          }
        });
      }
    }else{
      versionsEl.innerHTML = `<div class="empty">No versions uploaded yet.</div>`;
    }

    if(uploads.length){
      uploadsEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Version</th>
              <th>Uploader</th>
              <th>Uploaded</th>
            </tr>
          </thead>
          <tbody>
            ${uploads.map(u => `
              <tr>
                <td>${escapeHtml(u.version)}</td>
                <td>${escapeHtml(u.uploader || "unknown")}</td>
                <td>${escapeHtml(formatDate(u.created_at))}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }else{
      uploadsEl.innerHTML = `<div class="empty">No uploads found.</div>`;
    }

    try{
      const aRes = await api.get("/api/gamehosting/analytics?slug=" + encodeURIComponent(slug));
      const stats = aRes.stats || {};
      const fmtMs = (ms) => {
        const s = Math.floor((ms || 0) / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        return `${h}h ${m}m`;
      };
      analyticsEl.innerHTML = `
        <div class="grid">
          <div class="card">
            <div class="section-title"><h2>Total playtime</h2></div>
            <div class="badge accent" style="margin-top:8px">${escapeHtml(fmtMs(stats.total_playtime_ms || 0))}</div>
          </div>
          <div class="card">
            <div class="section-title"><h2>Total sessions</h2></div>
            <div class="badge" style="margin-top:8px">${escapeHtml(stats.total_sessions || 0)}</div>
          </div>
          <div class="card">
            <div class="section-title"><h2>Players</h2></div>
            <div class="badge" style="margin-top:8px">${escapeHtml(stats.players || 0)}</div>
          </div>
          <div class="card">
            <div class="section-title"><h2>Last played</h2></div>
            <div class="badge" style="margin-top:8px">${escapeHtml(formatDate(stats.last_played))}</div>
          </div>
        </div>
      `;
    }catch{
      analyticsEl.innerHTML = `<div class="empty">Analytics unavailable.</div>`;
    }
  }catch(err){
    gameTitle.textContent = "Dashboard unavailable";
    gameDesc.textContent = "Could not load game data. Check your access and slug.";
    versionsEl.innerHTML = `<div class="empty">No data available.</div>`;
    uploadsEl.innerHTML = `<div class="empty">No data available.</div>`;
    analyticsEl.innerHTML = `<div class="empty">No data available.</div>`;
  }
}

document.querySelectorAll("[data-tab]").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.getAttribute("data-tab");
    document.querySelectorAll("[data-tab]").forEach(b => b.classList.remove("accent"));
    btn.classList.add("accent");
    versionsEl.hidden = target !== "versions";
    uploadsEl.hidden = target !== "uploads";
    analyticsEl.hidden = target !== "analytics";
  });
});
</script>
</body>
</html>
