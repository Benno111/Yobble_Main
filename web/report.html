<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Report - Yobble</title>
<link rel="stylesheet" href="/style.css">
<style>
  :root{
    --rep-bg:#0a0d12;
    --rep-ink:#eef2ff;
    --rep-muted:#a5b0c6;
    --rep-card:#141a24;
    --rep-border:#283043;
    --rep-accent:#ff8a8a;
    --rep-accent-2:#4dd4ff;
  }
  body{
    background:radial-gradient(circle at 12% 15%,rgba(255,138,138,.18),transparent 40%),
               radial-gradient(circle at 80% 10%,rgba(77,212,255,.12),transparent 45%),
               var(--rep-bg);
    color:var(--rep-ink);
    font-family:"Space Grotesk","IBM Plex Sans","Segoe UI",sans-serif;
  }
  main{max-width:1200px}
  .rep-wrap{display:flex;flex-direction:column;gap:18px}
  .hero{
    display:grid;
    grid-template-columns:1.1fr .9fr;
    gap:20px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }
  .hero::before{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(120deg,rgba(255,138,138,.2),transparent 40%),
               linear-gradient(240deg,rgba(77,212,255,.12),transparent 40%);
    pointer-events:none;
  }
  .hero h1{margin:0 0 8px;font-size:38px}
  .hero p{margin:0;color:var(--rep-muted)}
  .pill{
    border:1px solid var(--rep-border);
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    color:var(--rep-muted);
    background:rgba(20,26,36,.6);
  }
  .hero-art{
    border-radius:16px;
    border:1px solid var(--rep-border);
    min-height:160px;
    background:
      linear-gradient(130deg,rgba(255,138,138,.25),rgba(20,26,36,.45)),
      repeating-linear-gradient(45deg,rgba(255,255,255,.05) 0 10px,transparent 10px 20px);
    display:flex;
    align-items:flex-end;
    padding:16px;
    font-weight:600;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:16px;
  }
  .panel{
    background:var(--rep-card);
    border:1px solid var(--rep-border);
    border-radius:16px;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  label{font-size:12px;color:var(--rep-muted)}
  input,select,textarea{
    width:100%;
    border:1px solid var(--rep-border);
    background:#0c1118;
    color:var(--rep-ink);
    padding:10px 12px;
    border-radius:10px;
    font-family:inherit;
  }
  textarea{resize:vertical}
  .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .status{color:var(--rep-muted);font-size:12px}
  @media (max-width: 900px){
    .hero{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<main class="rep-wrap">
  <section class="card hero">
    <div>
      <div class="pill">Safety</div>
      <h1>Report abuse</h1>
      <p>Submit a report and attach evidence so moderators can review faster.</p>
    </div>
    <div class="hero-art">Case intake</div>
  </section>

  <section class="grid">
    <div class="panel">
      <div class="pill">Report details</div>
      <div>
        <label for="target_type">Target type</label>
        <select id="target_type">
          <option value="user">User</option>
          <option value="game">Game</option>
          <option value="item">Item</option>
          <option value="listing">Marketplace listing</option>
          <option value="trade">Trade</option>
        </select>
      </div>
      <div>
        <label for="target_ref">Target reference (username/slug/code)</label>
        <input id="target_ref" placeholder="e.g. benno111 or dorfplatformer-9-2">
      </div>
      <div>
        <label for="category">Category</label>
        <select id="category">
          <option value="harassment">Harassment</option>
          <option value="scam">Scam</option>
          <option value="cheating">Cheating</option>
          <option value="nsfw">NSFW</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div>
        <label for="message">Message</label>
        <textarea id="message" rows="4" placeholder="Describe what happened (include dates, IDs, screenshots)."></textarea>
      </div>
      <div class="actions">
        <button id="submitBtn" class="primary">Submit report</button>
        <span class="status" id="status"></span>
      </div>
    </div>

    <div class="panel">
      <div class="pill">Evidence</div>
      <div class="muted">Upload evidence after submitting the report (max 10MB).</div>
      <input id="file" type="file">
      <div class="actions">
        <button class="secondary" id="uploadBtn" disabled>Upload evidence</button>
        <span class="status" id="evidenceInfo"></span>
      </div>
      <div class="pill">Tips</div>
      <div class="muted">Never share passwords or secrets. Include concrete references for faster resolution.</div>
    </div>
  </section>
</main>

<script type="module">
import { requireAuth } from "/js/auth.js";
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api.js";

await requireAuth();
await mountTopbar("report");

const params = new URLSearchParams(location.search);
const preType = params.get("target_type");
const preRef = params.get("target_ref") || params.get("target_id");

const status = document.querySelector("#status");
const submitBtn = document.querySelector("#submitBtn");
const uploadBtn = document.querySelector("#uploadBtn");
const evidenceInfo = document.querySelector("#evidenceInfo");

if (preType) document.querySelector("#target_type").value = preType;
if (preRef) document.querySelector("#target_ref").value = preRef;

let lastReportId = null;

submitBtn.onclick = async ()=>{
  status.textContent = "";
  try{
    const r = await api.post("/api/reports/submit", {
      target_type: document.querySelector("#target_type").value,
      target_ref: document.querySelector("#target_ref").value,
      category: document.querySelector("#category").value,
      message: document.querySelector("#message").value
    });
    lastReportId = r.report_id || null;
    status.textContent = lastReportId ? `Report submitted (#${lastReportId}).` : "Report submitted.";
    uploadBtn.disabled = !lastReportId;
    evidenceInfo.textContent = lastReportId ? "You can upload evidence now." : "Evidence requires report_id.";
  }catch(e){
    status.textContent = "Failed to submit report.";
  }
};

uploadBtn.onclick = async ()=>{
  status.textContent = "";
  const f = document.querySelector("#file").files?.[0];
  if(!f){ status.textContent = "Choose a file first."; return; }
  if(!lastReportId){ status.textContent = "Submit a report first."; return; }

  const fd = new FormData();
  fd.append("report_id", String(lastReportId));
  fd.append("file", f);

  try{
    await api("/api/reports/evidence", { method:"POST", body: fd });
    status.textContent = "Evidence uploaded.";
  }catch(e){
    status.textContent = "Upload failed.";
  }
};
</script>
</body>
</html>
