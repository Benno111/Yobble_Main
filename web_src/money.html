<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get Balance - Yobble</title>
<link rel="stylesheet" href="/theme.css" rel="stylesheet"><link rel="stylesheet" href="/style.css">
</head>
<body>
<main class="money-wrap">
  <section class="card hero">
    <div>
      
      <h1>Get Balance</h1>
      <p>Use the tools below to manage your in-app currency balance. Connect a crypto wallet to get started.</p>
    </div>
    <div class="hero-art">Balance boost</div>
  </section>
  <section class="panel wallet-lock" id="walletLock">
    <div class="panel-header">
      <div>
        <div class="h1" style="margin:0">Connect a crypto wallet</div>
        <div class="hint">A connected wallet is required to access platform money tools.</div>
      </div>
      <div class="pill" id="walletStatus">Not connected</div>
    </div>
    <div class="wallet-addr" id="walletAddr"></div>
    <div class="actions">
      <a class="primary" href="/connect-wallet.html" style="width:auto;text-decoration:none;display:inline-block">Connect wallet</a>
      <a class="ghost" href="/connect-wallet.html" style="width:auto;text-decoration:none;display:inline-block">Switch wallet</a>
    </div>
  </section>
  <section class="panel" id="purchasePanel">
    <div class="panel-header">
      <div>
        <div class="h1" style="margin:0">Purchase options</div>
        <div class="hint">1 in-app $ = $0.01 USD.</div>
      </div>
      <div class="pill">Top-ups</div>
    </div>
    <div class="rate-row">
      <input id="ethRate" type="number" min="1" step="0.01" placeholder="e.g. 3000" hidden>
      <button class="ghost" id="refreshRate" type="button" hidden>Auto fetch</button>
      <div class="hint">Sent to <code>0x11bf0f444574d29b49225f841b6b0e0a6c8534a7</code></div>
    </div>
    <div class="purchase-grid" id="purchaseGrid"></div>
    <div class="status" id="purchaseStatus"></div>
  </section>
  <section class="panel" id="grantPanel">
    <div class="panel-header">
      <div>
        <div class="h1" style="margin:0">Grant currency</div>
        <div class="hint">Leave username empty to grant to yourself.</div>
      </div>
      <div class="pill" id="roleBadge">User</div>
    </div>
    <div class="grid">
      <div class="field" id="usernameField">
        <label for="username">Username (mods/admin only)</label>
        <input id="username" placeholder="Target username">
      </div>
      <div class="field">
        <label for="amount">Amount</label>
        <input id="amount" type="number" placeholder="100" min="1" step="1">
      </div>
    </div>
    <div class="field">
      <label for="reason">Reason</label>
      <input id="reason" placeholder="Grant for testing">
    </div>
    <div class="actions">
      <button class="primary" id="grantBtn" style="width:auto">Grant</button>
      <button class="ghost" id="fillBtn" style="width:auto">Quick fill 100</button>
    </div>
    <div class="status" id="status"></div>
  </section>
</main>
<script type="module">
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api-pages/money.js";
import { requireAuth } from "/js/auth.js";
await mountTopbar("wallet");
const me = await requireAuth();
const isPrivileged = (me.role === "admin" || me.role === "moderator" || me.role === "mod");
const walletLock = document.getElementById("walletLock");
const walletStatus = document.getElementById("walletStatus");
const walletAddr = document.getElementById("walletAddr");
const grantPanel = document.getElementById("grantPanel");
const purchaseStatus = document.getElementById("purchaseStatus");
const purchaseGrid = document.getElementById("purchaseGrid");
const ethRateInput = document.getElementById("ethRate");
const refreshRateBtn = document.getElementById("refreshRate");
let connectedWallet = null;
const purchaseAddress = "0x11bf0f444574d29b49225f841b6b0e0a6c8534a7";
async function fetchEthRate(){
  try{
    purchaseStatus.textContent = "Fetching ETH price…";
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
    if (!res.ok) throw new Error("bad_response");
    const data = await res.json();
    const rate = Number(data?.ethereum?.usd || 0);
    if (!Number.isFinite(rate) || rate <= 0) throw new Error("bad_rate");
    ethRateInput.value = rate.toFixed(2);
    purchaseStatus.textContent = "ETH price updated.";
  }catch{
    purchaseStatus.textContent = "Could not fetch ETH price. Enter it manually.";
  }
}
async function getConnectedAccount(){
  if (!window.ethereum) return null;
  try{
    const accounts = await window.ethereum.request({ method: "eth_accounts" });
    return accounts && accounts[0] ? accounts[0] : null;
  }catch{
    return null;
  }
}
function setWalletState(addr){
  connectedWallet = addr || null;
  if (addr) {
    walletStatus.textContent = "Connected";
    walletAddr.textContent = `Wallet ${addr}`;
    grantPanel.classList.remove("disabled");
    walletLock.setAttribute("data-connected", "true");
  } else {
    walletStatus.textContent = "Not connected";
    walletAddr.textContent = window.ethereum ? "No wallet connected." : "No wallet detected. Install MetaMask or a compatible wallet.";
    grantPanel.classList.add("disabled");
    walletLock.removeAttribute("data-connected");
  }
}
const existing = await getConnectedAccount();
setWalletState(existing || null);
if (!existing) {
  const redirect = encodeURIComponent("/money.html");
  location.href = `/connect-wallet.html?redirect=${redirect}`;
}
fetchEthRate();
refreshRateBtn.addEventListener("click", fetchEthRate);
if (window.ethereum) {
  window.ethereum.on?.("accountsChanged", (accounts) => {
    const addr = accounts && accounts[0] ? accounts[0] : null;
    setWalletState(addr);
  });
}
const username = document.getElementById("username");
const amount = document.getElementById("amount");
const reason = document.getElementById("reason");
const status = document.getElementById("status");
const usernameField = document.getElementById("usernameField");
const roleBadge = document.getElementById("roleBadge");
const balanceEl = document.getElementById("walletBalance");
roleBadge.textContent = isPrivileged ? "Moderator" : "User";
if(!isPrivileged){
  usernameField.style.display = "none";
  grantPanel.style.display = "none";
}
document.getElementById("fillBtn").onclick = () => {
  amount.value = "100";
  if(!reason.value) reason.value = "Testing grant";
};
for (let usd = 1; usd <= 20; usd += 1) {
  const amount = usd * 100;
  const card = document.createElement("div");
  card.className = "purchase-card";
  card.innerHTML = `
    <h3>${amount} in-app $</h3>
    <div class="meta">$${usd.toFixed(2)} USD</div>
    <button class="primary" type="button" data-amount="${amount}">Buy $${usd}</button>
  `;
  const btn = card.querySelector("button");
  btn.addEventListener("click", async () => {
    purchaseStatus.textContent = "";
    if (!connectedWallet) {
      purchaseStatus.textContent = "Connect a crypto wallet before purchasing.";
      return;
    }
    const rate = Number(ethRateInput.value || 0);
    if (!Number.isFinite(rate) || rate <= 0) {
      purchaseStatus.textContent = "Enter a valid ETH price in USD.";
      return;
    }
    const usdAmount = usd;
    const ethAmount = usdAmount / rate;
    const wei = toWei(ethAmount);
    try{
      await window.ethereum.request({
        method: "eth_sendTransaction",
        params: [{
          from: connectedWallet,
          to: purchaseAddress,
          value: "0x" + wei.toString(16)
        }]
      });
      purchaseStatus.textContent = `Transaction submitted for $${usdAmount.toFixed(2)} USD.`;
    }catch{
      purchaseStatus.textContent = "Transaction cancelled or failed.";
    }
  });
  purchaseGrid.appendChild(card);
}
function toWei(eth){
  const parts = eth.toFixed(18).split(".");
  const whole = BigInt(parts[0] || "0");
  const frac = BigInt((parts[1] || "").padEnd(18, "0").slice(0, 18));
  return whole * 10n ** 18n + frac;
}
document.getElementById("grantBtn").onclick = async () => {
  status.textContent = "";
  if (!connectedWallet) {
    status.textContent = "Connect a crypto wallet before using money tools.";
    return;
  }
  try{
    const target = username.value.trim();
    const amt = Number(amount.value || 0);
    if (!Number.isFinite(amt) || amt <= 0) {
      status.textContent = "Amount must be a positive number.";
      return;
    }
    await api.post("/api/wallet/grant", {
      username: target || undefined,
      amount: amt,
      reason: reason.value
    });
    status.textContent = "Granted ✔";
    if (balanceEl) {
      try{
        const r = await api.get("/api/wallet");
        const balance = Number(r?.balance ?? 0);
        balanceEl.textContent = `Balance ${Number.isFinite(balance) ? balance : 0}`;
      }catch{}
    }
  }catch(e){
    status.textContent = e?.message ? `Failed: ${e.message}` : "Grant failed.";
  }
};
</script>
</body>
</html>
