<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Dashboard - Custom Levels</title>
<link rel="stylesheet" href="/theme.css" rel="stylesheet"><link rel="stylesheet" href="/style.css">
</head>
<body>
<main class="dash-wrap">
  <section class="card hero">
    <div>
      <h1 id="gameTitle">Loading…</h1>
      <p id="gameDesc" class="muted">Fetching game data.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <span class="pill" id="gameproject">project —</span>
        <select id="dashboardPage" style="min-width:220px">
          <option value="versions">Versions</option>
          <option value="uploads">Uploads</option>
          <option value="analytics">Analytics</option>
          <option value="levels">Custom Levels</option>
        </select>
        <label class="checkbox" style="align-items:center">
          <input type="checkbox" id="customLevelsToggle" checked>
          <span>Custom level browser</span>
        </label>
      </div>
    </div>
    <div>
      <div class="card">
        <div class="section-title">
          <h2>Overview</h2>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <span class="badge accent" id="latestVersion">Latest —</span>
          <span class="badge" id="publishedVersion">Published —</span>
        </div>
      </div>
    </div>
  </section>
  <section class="card">
    <div class="section-title">
      <h2>Custom Levels</h2>
    </div>
    <div id="levelsRoot" style="margin-top:12px"></div>
  </section>
</main>
<script type="module">
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api-pages/game-dashboard.js";
await mountTopbar("games");
const params = new URLSearchParams(location.search);
const project = params.get("project") || "";
const gameTitle = document.getElementById("gameTitle");
const gameDesc = document.getElementById("gameDesc");
const gameproject = document.getElementById("gameproject");
const dashboardPage = document.getElementById("dashboardPage");
const latestVersion = document.getElementById("latestVersion");
const publishedVersion = document.getElementById("publishedVersion");
const root = document.getElementById("levelsRoot");
const customLevelsToggle = document.getElementById("customLevelsToggle");
function escapeHtml(v){
  return String(v ?? "").replace(/[&<>"']/g, (c) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[c]));
}
function formatDate(ms){
  if (!ms) return "—";
  return new Date(ms).toLocaleString();
}
if(!project){
  gameTitle.textContent = "Missing project";
  gameDesc.textContent = "Provide ?project= in the URL.";
}else{
  try{
    const res = await api.get("/api/gamehosting/versions?project=" + encodeURIComponent(project));
    const g = res.game || {};
    const versions = res.versions || [];
    gameTitle.textContent = g.title || "Untitled";
    gameDesc.textContent = g.description || "No description yet.";
    gameproject.textContent = `project ${g.project || project}`;
    dashboardPage.value = "levels";
    const latest = versions[0]?.version || "—";
    const published = versions.find(v => v.is_published)?.version || "—";
    latestVersion.textContent = `Latest ${latest}`;
    publishedVersion.textContent = `Published ${published}`;
    try{
      const levelsRes = await api.get("/api/games/custom-lvl/" + encodeURIComponent(project) + "/list");
      const levels = levelsRes.levels || [];
      root.innerHTML = `
        <form id="levelUploadForm" style="margin-bottom:16px">
          <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
            <div>
              <label class="muted">Title</label>
              <input name="title" required placeholder="Level title" style="width:100%;margin-top:6px">
            </div>
            <div>
              <label class="muted">Version</label>
              <input name="version" required placeholder="1.0" style="width:100%;margin-top:6px">
            </div>
            <div>
              <label class="muted">Description</label>
              <input name="description" placeholder="Short description" style="width:100%;margin-top:6px">
            </div>
          </div>
          <div style="margin-top:10px">
            <label class="muted">Raw Data (JSON or text)</label>
            <textarea name="raw_data" rows="4" required style="margin-top:6px"></textarea>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
            <button class="badge accent" type="submit">Upload level</button>
            <span class="muted" id="levelUploadMsg"></span>
          </div>
        </form>
        ${levels.length ? `
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Version</th>
                <th>Uploader</th>
                <th>Updated</th>
                <th>Difficulty</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              ${levels.map(l => `
                <tr>
                  <td>${escapeHtml(l.title)}</td>
                  <td>${escapeHtml(l.version)}</td>
                  <td>${escapeHtml(l.uploader_username || "unknown")}</td>
                  <td>${escapeHtml(formatDate(l.updated_at))}</td>
                  <td>${l.difficulty ? escapeHtml(l.difficulty) : "—"}</td>
                  <td>
                    <button class="badge" data-level-download="${l.id}">Download</button>
                    <button class="badge" data-level-diff="${l.id}">Set difficulty</button>
                    <button class="badge" data-level-delete="${l.id}">Delete</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        ` : `<div class="empty">No custom levels yet.</div>`}
      `;

      const uploadForm = document.getElementById("levelUploadForm");
      if (uploadForm) {
        uploadForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("levelUploadMsg");
          msg.textContent = "";
          const fd = new FormData(uploadForm);
          try {
            const payload = {
              title: fd.get("title"),
              version: fd.get("version"),
              description: fd.get("description"),
              raw_data: fd.get("raw_data")
            };
            const resp = await api.post(
              "/api/games/custom-lvl/" + encodeURIComponent(project) + "/upload",
              payload
            );
            msg.textContent = resp.replaced ? "Replaced existing level." : "Uploaded.";
            setTimeout(() => location.reload(), 400);
          } catch {
            msg.textContent = "Upload failed.";
          }
        });
      }

      root.querySelectorAll("[data-level-delete]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-level-delete");
          if (!confirm("Delete this level?")) return;
          try{
            await api.del("/api/games/custom-lvl/" + encodeURIComponent(project) + "/delete/" + id);
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      root.querySelectorAll("[data-level-diff]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-level-diff");
          const input = prompt("Set difficulty (1-10):", "5");
          if (input === null) return;
          const diff = Number(input);
          if (!Number.isFinite(diff)) return;
          try{
            await api.post(
              "/api/games/custom-lvl/" + encodeURIComponent(project) + "/difficulty/" + id,
              { difficulty: diff }
            );
            location.reload();
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
      root.querySelectorAll("[data-level-download]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-level-download");
          try{
            const res = await api.get(
              "/api/games/custom-lvl/" + encodeURIComponent(project) + "/download/" + id
            );
            const raw = res.level?.raw_data || "";
            if (navigator.clipboard && raw) {
              await navigator.clipboard.writeText(raw);
              btn.textContent = "Copied";
              setTimeout(() => { btn.textContent = "Download"; }, 1000);
            } else {
              prompt("Level data", raw);
            }
          }catch{
            btn.textContent = "Failed";
          }
        });
      });
    }catch{
      root.innerHTML = `<div class="empty">Custom levels unavailable.</div>`;
    }
  }catch{
    gameTitle.textContent = "Dashboard unavailable";
    gameDesc.textContent = "Could not load game data. Check your access and project.";
    root.innerHTML = `<div class="empty">No data available.</div>`;
  }
}
dashboardPage.addEventListener("change", () => {
  const value = dashboardPage.value;
  const target = value === "uploads"
    ? "/game-dashboard-uploads.html"
    : value === "analytics"
      ? "/game-dashboard-analytics.html"
      : value === "levels"
        ? "/game-dashboard-levels.html"
        : "/game-dashboard-versions.html";
  const next = project ? `${target}?project=${encodeURIComponent(project)}` : target;
  location.href = next;
});
customLevelsToggle.addEventListener("change", () => {
  const target = customLevelsToggle.checked
    ? "/game-dashboard-levels.html"
    : "/game-dashboard-versions.html";
  const next = project ? `${target}?project=${encodeURIComponent(project)}` : target;
  location.href = next;
});
</script>
</body>
</html>
