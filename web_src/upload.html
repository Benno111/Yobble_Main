<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload - Yobble</title>
<link rel="stylesheet" href="/theme.css" rel="stylesheet"><link rel="stylesheet" href="/style.css">
</head>
<body>
<main class="up-wrap">
  <section class="card hero">
    <div>
      
      <h1>Publish a game build</h1>
      <p>Upload a web build ZIP to create or update a game version.</p>
    </div>
    <div class="hero-art">Upload queue</div>
  </section>
  <section class="grid">
    <div class="panel">
      <div class="pill">Game upload</div>
      <div>
        <label for="title">Title</label>
        <input id="title" placeholder="Game title">
      </div>
      <div>
        <label for="slug">Slug</label>
        <input id="slug" placeholder="game-slug (optional)">
      </div>
      <div>
        <label for="version">Version</label>
        <input id="version" placeholder="1.0.0">
      </div>
      <div>
        <label for="entry">Entry HTML</label>
        <input id="entry" placeholder="index.html">
      </div>
      <div>
        <label for="category">Category</label>
        <input id="category" placeholder="Action, Puzzle, RPG">
      </div>
      <div>
        <label for="description">Description</label>
        <textarea id="description" rows="4" placeholder="Short description"></textarea>
      </div>
    </div>
    <div class="panel">
      <div class="pill">ZIP build</div>
      <input id="zip" type="file" accept=".zip">
      <div class="actions">
        <button id="uploadBtn" class="primary" type="button">Upload</button>
        <span class="status" id="status"></span>
      </div>
      <div class="progress" aria-hidden="true" id="uploadProgressWrap">
        <div id="uploadProgress"></div>
      </div>
      <div class="pill">Notes</div>
      <div class="status">ZIP must include the entry HTML (default index.html).</div>
      <div class="status">Large uploads may take a minute to process.</div>
      <div class="pill">Latest upload</div>
      <div id="last" class="status">No uploads yet.</div>
    </div>
    <div class="panel">
      <div class="pill">Item upload</div>
      <div>
        <label for="item_code">Item code</label>
        <input id="item_code" placeholder="item-code">
      </div>
      <div>
        <label for="item_name">Item name</label>
        <input id="item_name" placeholder="Item name">
      </div>
      <div>
        <label for="item_desc">Description</label>
        <textarea id="item_desc" rows="4" placeholder="Short description"></textarea>
      </div>
      <div>
        <label for="item_icon">Icon (optional)</label>
        <input id="item_icon" type="file" accept=".png,.jpg,.jpeg,.webp">
      </div>
      <div class="actions">
        <button id="itemUploadBtn" class="primary" type="button">Upload item</button>
        <span class="status" id="itemStatus"></span>
      </div>
      <div class="status">Icons up to 2MB (PNG/JPG/WEBP).</div>
    </div>
  </section>
</main>
<script type="module">
import { mountTopbar } from "/js/layout.js";
import { api } from "/js/api-pages/upload.js";
import { requireAuth } from "/js/auth.js";
await mountTopbar("upload");
await requireAuth();
const status = document.getElementById("status");
const uploadBtn = document.getElementById("uploadBtn");
const last = document.getElementById("last");
const uploadProgress = document.getElementById("uploadProgress");
const uploadProgressWrap = document.getElementById("uploadProgressWrap");
const itemUploadBtn = document.getElementById("itemUploadBtn");
const itemStatus = document.getElementById("itemStatus");
function slugify(v){
  return String(v || "")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 80);
}
uploadBtn.onclick = async () => {
  status.textContent = "";
  uploadBtn.disabled = true;
  if (uploadProgressWrap) uploadProgressWrap.style.display = "block";
  uploadProgress.style.width = "0%";
  const zip = document.getElementById("zip").files?.[0];
  if (!zip) {
    status.textContent = "Select a ZIP file.";
    uploadBtn.disabled = false;
    if (uploadProgressWrap) uploadProgressWrap.style.display = "none";
    return;
  }
  const fd = new FormData();
  fd.append("zip", zip);
  const title = document.getElementById("title").value.trim();
  const slugInput = document.getElementById("slug").value.trim();
  const slug = slugInput || slugify(title);
  const version = document.getElementById("version").value.trim();
  const entry = document.getElementById("entry").value.trim() || "index.html";
  const category = document.getElementById("category").value.trim();
  const description = document.getElementById("description").value.trim();
  if (!title || !version) {
    status.textContent = "Title and version are required.";
    uploadBtn.disabled = false;
    if (uploadProgressWrap) uploadProgressWrap.style.display = "none";
    return;
  }
  if (!slug) {
    status.textContent = "Slug must include letters or numbers.";
    uploadBtn.disabled = false;
    if (uploadProgressWrap) uploadProgressWrap.style.display = "none";
    return;
  }
  fd.append("title", title);
  fd.append("slug", slug);
  fd.append("version", version);
  fd.append("entry_html", entry);
  fd.append("category", category);
  fd.append("description", description);
  try{
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/api/gamehosting/upload");
    const token = localStorage.getItem("token");
    if (token) {
      xhr.setRequestHeader("Authorization", "Bearer " + token);
    }
    xhr.upload.addEventListener("progress", (evt) => {
      if (!evt.lengthComputable) return;
      const pct = Math.round((evt.loaded / evt.total) * 100);
      uploadProgress.style.width = pct + "%";
    });
    xhr.addEventListener("load", () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        let r = {};
        try{ r = JSON.parse(xhr.responseText || "{}"); }catch{}
        status.textContent = r?.url ? `Uploaded ✔ ${r.url}` : "Uploaded ✔";
        last.textContent = r?.url ? `Latest: ${r.url}` : "Latest: uploaded.";
      } else {
        let msg = "Upload failed.";
        try{
          const r = JSON.parse(xhr.responseText || "{}");
          if (r?.error) msg = `Upload failed: ${r.error}`;
        }catch{}
        status.textContent = msg;
      }
      uploadBtn.disabled = false;
    });
    xhr.addEventListener("error", () => {
      status.textContent = "Upload failed.";
      uploadBtn.disabled = false;
    });
    xhr.addEventListener("loadend", () => {
      if (uploadProgressWrap) uploadProgressWrap.style.display = "none";
    });
    xhr.send(fd);
  }catch(e){
    status.textContent = e?.message ? `Upload failed: ${e.message}` : "Upload failed.";
    uploadBtn.disabled = false;
    if (uploadProgressWrap) uploadProgressWrap.style.display = "none";
  }
};
itemUploadBtn.onclick = async () => {
  itemStatus.textContent = "";
  itemUploadBtn.disabled = true;
  const code = document.getElementById("item_code").value.trim();
  const name = document.getElementById("item_name").value.trim();
  const description = document.getElementById("item_desc").value.trim();
  const icon = document.getElementById("item_icon").files?.[0];
  if (!code || !name) {
    itemStatus.textContent = "Item code and name are required.";
    itemUploadBtn.disabled = false;
    return;
  }
  const fd = new FormData();
  fd.append("code", code);
  fd.append("name", name);
  fd.append("description", description);
  if (icon) fd.append("icon", icon);
  try{
    const r = await api.post("/api/items/upload", fd);
    itemStatus.textContent = r?.status ? `Item uploaded (${r.status}).` : "Item uploaded.";
  }catch(e){
    itemStatus.textContent = e?.message ? `Upload failed: ${e.message}` : "Upload failed.";
  }finally{
    itemUploadBtn.disabled = false;
  }
};
</script>
</body>
</html>
