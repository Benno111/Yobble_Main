<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Settings - Yobble</title>
<link rel="stylesheet" href="/theme.css" rel="stylesheet"><link rel="stylesheet" href="/style.css">
</head>
<body>
<main>
  <section class="card hero">
    <div>
      <h1>User settings</h1>
      <p>Control your account preferences, privacy, and notifications.</p>
      <div class="hero-meta">
        <span class="pill">Account</span>
        <span class="pill">Privacy</span>
        <span class="pill">Security</span>
      </div>
    </div>
    <div class="actions" style="justify-content:flex-end">
      <button type="submit" form="settingsForm">Save changes</button>
      <span class="pill" id="saveStatus">Not saved</span>
    </div>
  </section>

  <form id="settingsForm" class="grid" style="margin-top:16px">
    <section class="card">
      <h2>Profile</h2>
      <div class="form-field">
        <label for="displayName">Display name</label>
        <input id="displayName" name="displayName" type="text" placeholder="Add a public display name">
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="statusText">Status</label>
        <input id="statusText" name="statusText" type="text" placeholder="Set a short status message">
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="bio">Bio</label>
        <textarea id="bio" name="bio" rows="4" placeholder="Tell people about you"></textarea>
      </div>
    </section>

    <section class="card">
      <h2>Privacy</h2>
      <div class="list" style="margin-top:10px">
        <label class="checkbox">
          <input type="checkbox" name="showProfile" checked>
          <span>Show my profile in search results</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="showStatus" checked>
          <span>Allow friends to see my status</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="shareActivity">
          <span>Share my recent activity</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Notifications</h2>
      <div class="list" style="margin-top:10px">
        <label class="checkbox">
          <input type="checkbox" name="notifFriend" checked>
          <span>Friend requests</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="notifMessage" checked>
          <span>Direct messages</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="notifUpdates">
          <span>Product updates and news</span>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Preferences</h2>
      <div class="form-field">
        <label for="language">Language</label>
        <select id="language" name="language">
          <option value="en" selected>English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
        </select>
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="timezone">Timezone</label>
        <select id="timezone" name="timezone">
          <option value="utc" selected>UTC</option>
          <option value="america">America</option>
          <option value="europe">Europe</option>
          <option value="asia">Asia</option>
        </select>
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="theme">Theme</label>
        <select id="theme" name="theme">
          <option value="system" selected>System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </section>

    <section class="card">
      <h2>Security</h2>
      <div class="form-field">
        <label for="email">Email address</label>
        <input id="email" name="email" type="email" placeholder="name@example.com">
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="password">New password</label>
        <input id="password" name="password" type="password" placeholder="Enter a new password">
      </div>
      <div class="form-field" style="margin-top:12px">
        <label for="twoFactor">Two-factor authentication</label>
        <select id="twoFactor" name="twoFactor">
          <option value="off" selected>Off</option>
          <option value="app">Authenticator app</option>
          <option value="sms">SMS</option>
        </select>
      </div>
      <div class="form-field" style="margin-top:12px">
        <label>Authenticator app setup</label>
        <div id="twoFactorStatus" class="muted">Checking status...</div>
        <div class="actions" style="margin-top:10px">
          <button type="button" id="twoFactorSetupBtn">Set up authenticator</button>
          <button type="button" class="danger" id="twoFactorDisableBtn" style="display:none">Disable 2FA</button>
        </div>
        <div id="twoFactorSetup" style="display:none; margin-top:12px">
          <p class="small">Add this key to your authenticator app, then enter the code.</p>
          <div class="form-field" style="margin-top:8px">
            <label for="twoFactorSecret">Secret key</label>
            <input id="twoFactorSecret" readonly>
          </div>
          <div class="form-field" style="margin-top:8px">
            <label for="twoFactorOtpauth">OTPAuth URL</label>
            <input id="twoFactorOtpauth" readonly>
          </div>
          <div class="form-field" style="margin-top:8px">
            <label for="twoFactorCode">Verification code</label>
            <input id="twoFactorCode" inputmode="numeric" autocomplete="one-time-code" placeholder="123456">
          </div>
          <div class="actions" style="margin-top:10px">
            <button type="button" id="twoFactorVerifyBtn">Verify & Enable</button>
          </div>
        </div>
        <div id="twoFactorDisable" style="display:none; margin-top:12px">
          <div class="form-field">
            <label for="twoFactorDisableCode">Code to disable</label>
            <input id="twoFactorDisableCode" inputmode="numeric" autocomplete="one-time-code" placeholder="123456">
          </div>
          <div class="actions" style="margin-top:10px">
            <button type="button" class="danger" id="twoFactorDisableConfirm">Confirm disable</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Danger zone</h2>
      <p class="small">Take care with these actions. They affect your account immediately.</p>
      <div class="actions" style="margin-top:12px">
        <button type="button" class="danger">Deactivate account</button>
        <button type="button" class="danger">Delete account</button>
      </div>
    </section>
  </form>
</main>

<script type="module">
  import { mountTopbar } from "/js/layout.js";
  import { api } from "/js/api.js";
  await mountTopbar("uprofile");

  const form = document.getElementById("settingsForm");
  const status = document.getElementById("saveStatus");
  const storageKey = "userSettingsDraft";

  function loadDraft(){
    try{
      const raw = localStorage.getItem(storageKey);
      if (!raw) return;
      const data = JSON.parse(raw);
      Object.entries(data).forEach(([key, value]) => {
        const field = form.elements.namedItem(key);
        if (!field) return;
        if (field.type === "checkbox") {
          field.checked = Boolean(value);
        } else {
          field.value = value;
        }
      });
      status.textContent = "Draft loaded";
    } catch (err) {
      status.textContent = "Draft unavailable";
    }
  }

  function saveDraft(){
    const payload = {};
    Array.from(form.elements).forEach((field) => {
      if (!field.name) return;
      if (field.type === "checkbox") {
        payload[field.name] = field.checked;
      } else if (field.type !== "submit" && field.type !== "button") {
        payload[field.name] = field.value;
      }
    });
    localStorage.setItem(storageKey, JSON.stringify(payload));
    const stamp = new Date();
    status.textContent = `Saved ${stamp.toLocaleTimeString()}`;
  }

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    saveDraft();
  });

  loadDraft();

  const twoFactorStatus = document.getElementById("twoFactorStatus");
  const twoFactorSetupBtn = document.getElementById("twoFactorSetupBtn");
  const twoFactorDisableBtn = document.getElementById("twoFactorDisableBtn");
  const twoFactorSetup = document.getElementById("twoFactorSetup");
  const twoFactorSecret = document.getElementById("twoFactorSecret");
  const twoFactorOtpauth = document.getElementById("twoFactorOtpauth");
  const twoFactorCode = document.getElementById("twoFactorCode");
  const twoFactorVerifyBtn = document.getElementById("twoFactorVerifyBtn");
  const twoFactorDisable = document.getElementById("twoFactorDisable");
  const twoFactorDisableCode = document.getElementById("twoFactorDisableCode");
  const twoFactorDisableConfirm = document.getElementById("twoFactorDisableConfirm");

  function setTwoFactorStatus(text, isError = false){
    twoFactorStatus.textContent = text;
    twoFactorStatus.style.color = isError ? "#b33" : "";
  }

  async function refreshTwoFactor(){
    try{
      const data = await api.get("/api/auth/2fa/status");
      if (data?.enabled) {
        setTwoFactorStatus("Enabled");
        twoFactorSetupBtn.style.display = "none";
        twoFactorDisableBtn.style.display = "inline-flex";
        twoFactorDisable.style.display = "block";
        twoFactorSetup.style.display = "none";
      } else {
        setTwoFactorStatus("Off");
        twoFactorSetupBtn.style.display = "inline-flex";
        twoFactorDisableBtn.style.display = "none";
        twoFactorDisable.style.display = "none";
      }
    } catch {
      setTwoFactorStatus("Unavailable", true);
      twoFactorSetupBtn.disabled = true;
      twoFactorDisableBtn.disabled = true;
    }
  }

  twoFactorSetupBtn.addEventListener("click", async () => {
    setTwoFactorStatus("Generating setup...", false);
    try{
      const data = await api.post("/api/auth/2fa/setup", {});
      twoFactorSecret.value = data?.secret || "";
      twoFactorOtpauth.value = data?.otpauth || "";
      twoFactorCode.value = "";
      twoFactorSetup.style.display = "block";
      setTwoFactorStatus("Enter the code from your app to enable.");
    } catch {
      setTwoFactorStatus("Setup failed. Try again.", true);
    }
  });

  twoFactorVerifyBtn.addEventListener("click", async () => {
    const code = String(twoFactorCode.value || "").trim();
    if (!code) {
      setTwoFactorStatus("Enter a code to verify.", true);
      return;
    }
    try{
      await api.post("/api/auth/2fa/enable", { code });
      twoFactorCode.value = "";
      twoFactorSetup.style.display = "none";
      await refreshTwoFactor();
    } catch {
      setTwoFactorStatus("Invalid code. Try again.", true);
    }
  });

  twoFactorDisableBtn.addEventListener("click", () => {
    twoFactorDisable.style.display = "block";
    twoFactorDisableCode.focus();
  });

  twoFactorDisableConfirm.addEventListener("click", async () => {
    const code = String(twoFactorDisableCode.value || "").trim();
    if (!code) {
      setTwoFactorStatus("Enter a code to disable.", true);
      return;
    }
    try{
      await api.post("/api/auth/2fa/disable", { code });
      twoFactorDisableCode.value = "";
      await refreshTwoFactor();
    } catch {
      setTwoFactorStatus("Disable failed. Check code.", true);
    }
  });

  refreshTwoFactor();
</script>
</body>
</html>
